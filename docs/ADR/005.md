
# ADR: 005 - Escolha da tecnologia de Mensageria

Data: 2025-10-29

Responsável: André Vinícius Falcão

## :open_book: Contexto
A aplicação `Controle de Lançamentos` recebe e publica mensagens para comunicar-se com o contexto de `Consolidação Financeira` essa comunicação é intermediada por alguma estrutura capaz de manter os critérios e requisitos de escala e performance.
  

## :bulb: Decisão
A decisão é utilizar o Apache Kafka como tecnologia de mensageria destina-se a de utilizar sua retenção nativa de mensagens para garantir estratégias de recuperação. Seguindo a estratégia onde o `Controle de Lançamentos API` recebe uma requisição envia a mensagem para o Tópico, e mesmo que a seguir, a mensagem não possa ser gravada no banco Postgres por quaisquer eventualidades mesmo após a retentiva sistêmica, a mesma pode ser recuperada através do tópico. Tornando a aplicação mais resistente a falhas e capaz de responder eventos de indisponibilidade da infraestrutura de banco.

  

## :balance_scale: Justificativa
- Garante a possibilidade de que as ações no sistema sejam auditadas.
- Garante a consistência de cada evento e a possível recuperação, em um cenário onde o `Worker` fique fora do ar por alguns instante ou mais tempo, seria possível continuar a consolidação sem prejuízo no calculo.
- Não depende de mensagens ordenadas.
- Pode ser substituido pelos principais serviços gerenciados de mensageria.
  

  Consideração para o uso Inicial em nuvem:

| Provedor de Nuvem | Nome do Serviço | Custo Mínimo Mensal |
|--|--|--|
| Azure | Azure Event Grid | $0.60 / 1 milhão de operações |
| AWS | AWS SNS | $0,50 / 1 milhão de operações |
| GCP | GCP Pub/Sub | $40,00 / terabyte |


## :bulb: Alternativas Consideradas
- **Comunicação direta entre as APIs:** A abordagem foi desencorajada principalmente pela estratégia de retenção e recuperação descrita na sessão `Decisão`. Porém existem outros fatores:
	- A interferência das capacidades entre os contextos em desacordo com a **RNF02**.
	- A possível perda de mensagens e considerando a sobrecarga que o requisito **RNF01** descreve.
	- Incapacidade de escalar individualmente, em um cenário especulativo é provável que tenhamos mais operadores fazendo lançamentos financeiros do que agente de Gestão consultando relatório consolidado. Ter as aplicações diretamente conectadas exigiria que infraestrutura de uma delas fosse capaz de receber e processar todas as requisições da outra a fim de não causar interferência no serviço dos Lançamentos.
- **Mensageria RabbitMq:** O comportamento do Rabbit Mq é que as mensagens sejam excluidas após serem recebidas, é possível configurar comportamentos difentes, mas o Kafka promovia essa capacidade nativamente. Além da implementação do Rabbit Mq depender de algumas intervenções maiores no código, dificultando a intercambialidade com outras tecnologias. 


## :hourglass_flowing_sand: **Consequências**
:white_check_mark: **Positivas**
- Capacita as aplicações para escalarem individualmente.
- Possibilita a retenção e recuperação das mensagens de forma nativa.
- Habilita a comunicação assíncrona entre os contextos.

:no_entry: **Negativas**

- Aumento de custo para manter toda a infraestrutura.
- Maior necessidade de gerenciamento por adicionar mais um componente ao sistema.